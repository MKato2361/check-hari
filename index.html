<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>チェックリスト管理ツール</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pizzip@3.1.5/dist/pizzip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docxtemplater@3.42.2/build/docxtemplater.js"></script>
</head>
<body class="bg-gray-100 p-4">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-2xl font-bold mb-4">チェックリスト管理ツール</h1>
    <div class="mb-4 flex flex-row flex-wrap items-center space-x-2">
      <input type="file" id="fileInput" class="border p-2 flex-shrink-0" />
      <button onclick="exportExcel()" class="bg-green-500 text-white px-4 py-2 rounded flex-shrink-0">Excel出力</button>
      <input type="file" id="wordTemplate" class="border p-2 flex-shrink-0" />
      <button onclick="exportWord()" class="bg-blue-500 text-white px-4 py-2 rounded flex-shrink-0">Word出力</button>
    </div>
    <div id="progressContainer" class="mb-4 hidden">
      <div class="w-full bg-gray-300 rounded">
        <div id="progressBar" class="bg-green-500 text-xs leading-none py-1 text-center text-white rounded" style="width:0%">0%</div>
      </div>
      <div id="progressText" class="text-sm mt-1"></div>
    </div>
    <div id="message" class="mb-4 text-red-500"></div>
    <div class="mb-4 flex items-center space-x-2">
      <input type="text" id="newCheckItem" placeholder="新しいチェック項目名" class="border p-2 rounded flex-grow"/>
      <button onclick="addCheckItem()" class="bg-purple-500 text-white px-4 py-2 rounded flex-shrink-0">チェック項目追加</button>
    </div>
    <div id="checklist-container" class="space-y-4"></div>
  </div>

<script>
let data = [];
let headers = [];

// Excel読み込み
document.getElementById("fileInput").addEventListener("change", handleFile, false);
function handleFile(e){
  const file = e.target.files[0];
  const reader = new FileReader();
  reader.onload = function(evt){
    const wb = XLSX.read(evt.target.result, {type:"binary", cellDates:true, raw:true});
    const ws = wb.Sheets[wb.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(ws, {header:1, defval:""});
    headers = json[0];
    const managementIdx=headers.findIndex(h=>h.includes("管理番号"));
    const propertyIdx=headers.findIndex(h=>h.includes("物件名"));
    const workTypeIdx=headers.findIndex(h=>h.includes("作業タイプ"));
    const startIdx=headers.findIndex(h=>h.includes("予定開始"));
    const endIdx=headers.findIndex(h=>h.includes("予定終了"));
    data=[];
    for(let i=1;i<json.length;i++){
      if(json[i].length===0) continue;
      data.push({
        id:i,
        managementNumber: json[i][managementIdx]||"",
        propertyName: json[i][propertyIdx]||"",
        workType: json[i][workTypeIdx]||"",
        startTime: json[i][startIdx]||"",
        endTime: json[i][endIdx]||"",
        checks:[]
      });
    }
    renderChecklist();
  };
  reader.readAsBinaryString(file);
}

// チェック項目追加
function addCheckItem(){
  const name=document.getElementById("newCheckItem").value.trim();
  if(!name) return;
  data.forEach(item=>{
    item.checks.push({name, state:0, date:""});
  });
  document.getElementById("newCheckItem").value="";
  renderChecklist();
}

// チェック操作
function handleCheck(itemId, idx){
  const item=data.find(d=>d.id===itemId);
  const check=item.checks[idx];
  check.state=(check.state+1)%3;
  if(check.state===1){
    check.date=new Date().toLocaleString();
  } else if(check.state===0){
    check.date="";
  }
  renderChecklist();
}

// レンダリング
function renderChecklist(){
  const cont=document.getElementById("checklist-container");
  cont.innerHTML="";
  data.forEach(item=>{
    const isAllDone = item.checks.length > 0 && item.checks.every(c => c.state === 1 || c.state === 2);

    const div=document.createElement("div");
    div.className=`bg-white p-4 rounded shadow border-2 ${isAllDone ? "border-green-500" : "border-gray-200"}`;

    const scheduleHtml = `
      <div class="text-sm text-gray-600">
        開始: ${item.startTime || "-"}　
        終了: ${item.endTime || "-"}
      </div>`;

    let checksHtml="";
    item.checks.forEach((c,idx)=>{
      const sym=c.state===1?"✔":c.state===2?"✖":"";
      const color=c.state===1?"bg-green-500":c.state===2?"bg-red-500":"bg-gray-200";
      // Use flexbox for each checklist item to ensure alignment
      checksHtml+=`
        <div class="flex items-center space-x-2 my-1">
        <button onclick="handleCheck(${item.id},${idx})" 
          class="w-8 h-8 rounded-full ${color} text-white text-sm flex-shrink-0">${sym}</button>
        <span class="ml-2">${c.name}</span>
        ${c.date?`<span class="ml-auto text-sm text-gray-500">${c.date}</span>`:""}
        </div>`;
    });

    const workTypeStr = item.workType ? `[${item.workType}]` : "";
    const title = [item.managementNumber, item.propertyName, workTypeStr].filter(Boolean).join(" ");

    div.innerHTML=`
      <div class="font-bold text-lg">
        ${title}
      </div>
      ${scheduleHtml}
      <div class="ml-4 mt-2">
        ${checksHtml || "<span class='text-gray-400 text-sm'>チェック項目なし</span>"}
      </div>`;
    cont.appendChild(div);
  });
  updateProgress();
}

// 進捗バー
function updateProgress(){
  let total=0, done=0;
  data.forEach(item=>{
    total+=item.checks.length;
    done+=item.checks.filter(c=>c.state===1).length;
  });
  const percent= total===0?0:Math.round(done/total*100);
  document.getElementById("progressContainer").classList.remove("hidden");
  document.getElementById("progressBar").style.width=percent+"%";
  document.getElementById("progressBar").innerText=percent+"%";
  document.getElementById("progressText").innerText=`完了 ${done} / ${total}`;
}

// Excel出力
function exportExcel(){
  if(data.length===0){ alert("データがありません"); return; }
  const ws_data=[["管理番号","物件名","作業タイプ","予定開始","予定終了"]];
  let checkNames=[];
  data.forEach(item=>{
    item.checks.forEach(c=>{
      if(!checkNames.includes(c.name)) checkNames.push(c.name);
    });
  });
  checkNames.forEach(name=>{
    ws_data[0].push(name+" 状態");
    ws_data[0].push(name+" 日時");
  });
  data.forEach(item=>{
    const row=[item.managementNumber,item.propertyName,item.workType,item.startTime,item.endTime];
    checkNames.forEach(name=>{
      const c=item.checks.find(x=>x.name===name);
      row.push(c? (c.state===1?"✔":c.state===2?"✖":""):"");
      row.push(c?c.date:"");
    });
    ws_data.push(row);
  });
  const ws=XLSX.utils.aoa_to_sheet(ws_data);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Sheet1");
  const wbout=XLSX.write(wb,{bookType:"xlsx", type:"array"});
  saveAs(new Blob([wbout],{type:"application/octet-stream"}),"checklist.xlsx");
}

// Word出力
async function exportWord() {
    if (data.length === 0) {
        alert("Excelデータを先に読み込んでください。");
        return;
    }
    const file = document.getElementById("wordTemplate").files[0];
    if (!file) {
        alert("Wordテンプレートを選択してください。");
        return;
    }

    const content = await file.arrayBuffer();
    const zipOut = new JSZip();
    
    // 日付と時刻のフォーマット関数を定義
    const dayOfWeek = ['日曜日', '月曜日', '火曜日', '水曜日', '木曜日', '金曜日', '土曜日'];
    const h = (d) => ('0' + d.getHours()).slice(-2);
    const m = (d) => ('0' + d.getMinutes()).slice(-2);

    for (const item of data) {
        const zip = new PizZip(content);
        let doc;
        try {
            doc = new window.docxtemplater(zip, { paragraphLoop: true, linebreaks: true });
        } catch (err) {
            console.error("テンプレート読み込みエラー:", err);
            document.getElementById("message").innerText = "テンプレート読み込みエラー: " + err.message;
            return;
        }

        const d_start = item.startTime ? new Date(item.startTime) : null;
        const d_end = item.endTime ? new Date(item.endTime) : null;

        const date = d_start ? `${d_start.getFullYear()}年${d_start.getMonth() + 1}月${d_start.getDate()}日${dayOfWeek[d_start.getDay()]}` : "";
        const startTime = d_start ? `${h(d_start)}:${m(d_start)}` : "";
        const endTime = d_end ? `${h(d_end)}:${m(d_end)}` : "";

        const dataToRender = {
            '管理番号': item.managementNumber,
            '物件名': item.propertyName,
            '日付': date,
            '予定開始': startTime,
            '予定終了': endTime
        };

        // デバッグ用: 実際にdocxtemplaterに渡されるデータを確認
        console.log('--- Rendering data ---');
        console.log(dataToRender);
        
        doc.setData(dataToRender);

        try {
            doc.render();
        } catch (err) {
            console.error("ドキュメント生成エラー:", err);
            document.getElementById("message").innerText = `ドキュメント生成エラー: ${item.propertyName} - ` + err.message;
            continue;
        }
        
        const out = doc.getZip().generate({
            type: "blob",
            mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document"
        });
        const fname = (item.managementNumber || "") + "_" + (item.propertyName || "") + ".docx";
        zipOut.file(fname, out);
    }
    
    zipOut.generateAsync({ type: "blob" }).then(function(content) {
        saveAs(content, "word_outputs.zip");
    }).catch(err => {
        console.error("ZIPファイル生成エラー:", err);
        document.getElementById("message").innerText = "ZIPファイル生成エラー: " + err.message;
    });
}
</script>
</body>
</html>
