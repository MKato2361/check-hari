<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>チェックリスト管理ツール</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pizzip@3.1.5/dist/pizzip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docxtemplater@3.42.2/build/docxtemplater.js"></script>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4F46E5"/>
</head>
<body class="bg-gray-100 p-4">
<div class="max-w-4xl mx-auto">
  <h1 class="text-2xl font-bold mb-4">チェックリスト管理ツール</h1>
  
  <!-- ファイル選択と出力ボタン -->
  <div class="mb-4">
    <div class="flex flex-row flex-wrap items-center space-x-2 mb-2">
      <label class="flex items-center space-x-2 border p-2 rounded bg-white cursor-pointer flex-shrink-0">
          <span class="text-gray-500">Excelファイルを選択</span>
          <input type="file" id="fileInput" class="hidden" onchange="updateFileName('fileInput','excelFileName')" />
      </label>
      <span id="excelFileName" class="text-sm text-gray-600">選択されていません</span>
      <button onclick="exportExcel()" class="bg-green-500 text-white px-4 py-2 rounded flex-shrink-0">チェックリスト出力</button>
    </div>
    <div class="flex flex-row flex-wrap items-center space-x-2">
      <label class="flex items-center space-x-2 border p-2 rounded bg-white cursor-pointer flex-shrink-0">
          <span class="text-gray-500">Wordテンプレートを選択（省略可）</span>
          <input type="file" id="wordTemplate" class="hidden" onchange="updateFileName('wordTemplate','wordFileName')" />
      </label>
      <span id="wordFileName" class="text-sm text-gray-600">選択されていません</span>
      <button onclick="exportWord()" class="bg-blue-500 text-white px-4 py-2 rounded flex-shrink-0">貼紙出力</button>
    </div>
  </div>

  <!-- 完了案件折りたたみボタン -->
  <div class="mb-4 flex items-center space-x-2">
    <button id="toggleCompletedBtn" onclick="toggleCompletedAll()" class="bg-gray-600 text-white px-4 py-2 rounded">
      完了案件を折りたたむ
    </button>
  </div>

  <!-- 進捗バー -->
  <div id="progressContainer" class="mb-4 hidden">
    <div class="w-full bg-gray-300 rounded">
      <div id="progressBar" class="bg-green-500 text-xs leading-none py-1 text-center text-white rounded" style="width:0%">0%</div>
    </div>
    <div id="progressText" class="text-sm mt-1"></div>
  </div>
  <div id="message" class="mb-4 text-red-500"></div>

  <!-- 新規チェック項目追加 -->
  <div class="mb-4 flex items-center space-x-2">
    <input type="text" id="newCheckItem" placeholder="新しいチェック項目名" class="border p-2 rounded flex-grow"/>
    <button onclick="addCheckItem()" class="bg-purple-500 text-white px-4 py-2 rounded flex-shrink-0">チェック項目追加</button>
  </div>

  <div id="checklist-container" class="space-y-4"></div>
</div>

<script>
let data = [];
let headers = [];
let collapseCompleted = true;
const STORAGE_KEY = "checklist_data";

// 永続化
function saveData(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }
function loadData(){
  const saved = localStorage.getItem(STORAGE_KEY);
  if(saved){ try{ data=JSON.parse(saved); renderChecklist(); }catch(e){console.error(e);} }
}

// ファイル名表示
function updateFileName(inputId, spanId){
  const fileInput=document.getElementById(inputId);
  if(fileInput.files.length>0) document.getElementById(spanId).textContent=fileInput.files[0].name;
}

// Excel読み込み
document.getElementById("fileInput").addEventListener("change",handleFile,false);
function handleFile(e){
  const file=e.target.files[0];
  const reader=new FileReader();
  reader.onload=function(evt){
    const wb=XLSX.read(evt.target.result,{type:"binary",cellDates:true,raw:true});
    const ws=wb.Sheets[wb.SheetNames[0]];
    const json=XLSX.utils.sheet_to_json(ws,{header:1,defval:""});
    headers=json[0];
    const managementIdx=headers.findIndex(h=>h.includes("管理番号"));
    const propertyIdx=headers.findIndex(h=>h.includes("物件名"));
    const workTypeIdx=headers.findIndex(h=>h.includes("作業タイプ"));
    const startIdx=headers.findIndex(h=>h.includes("予定開始"));
    const endIdx=headers.findIndex(h=>h.includes("予定終了"));
    data=[];
    for(let i=1;i<json.length;i++){
      if(json[i].length===0) continue;
      data.push({id:i, managementNumber: json[i][managementIdx]||"", propertyName: json[i][propertyIdx]||"", workType: json[i][workTypeIdx]||"", startTime: json[i][startIdx]||"", endTime: json[i][endIdx]||"", checks:[]});
    }
    saveData();
    renderChecklist();
  };
  reader.readAsBinaryString(file);
}

// チェック項目追加
function addCheckItem(){
  const name=document.getElementById("newCheckItem").value.trim();
  if(!name) return;
  data.forEach(item=>{ item.checks.push({name,state:0,date:""}); });
  document.getElementById("newCheckItem").value="";
  saveData();
  renderChecklist();
}

// チェック操作
function handleCheck(itemId, idx){
  const item=data.find(d=>d.id===itemId);
  const check=item.checks[idx];
  check.state=(check.state+1)%3;
  if(check.state===1){
    const now=new Date();
    const YYYY=now.getFullYear(), MM=('0'+(now.getMonth()+1)).slice(-2), DD=('0'+now.getDate()).slice(-2);
    const HH=('0'+now.getHours()).slice(-2), mm=('0'+now.getMinutes()).slice(-2);
    const week=["日","月","火","水","木","金","土"][now.getDay()];
    check.date=`${YYYY}/${MM}/${DD}(${week}) ${HH}:${mm}`;
  } else if(check.state===0){ check.date=""; }
  saveData();
  renderChecklist();
}

// レンダリング
function renderChecklist(){
  const cont=document.getElementById("checklist-container");
  cont.innerHTML="";
  data.forEach(item=>{
    const isAllDone=item.checks.length>0 && item.checks.every(c=>c.state===1||c.state===2);

    const div=document.createElement("div");
    let classes=`bg-white p-4 rounded shadow border-2 ${isAllDone?"border-green-500":"border-gray-200"} mb-2`;
    if(isAllDone) div.classList.add("bg-gray-100","text-gray-500");
    div.className=classes;

    const formatDateTime=dt=>{
      if(!dt) return "-";
      const d=new Date(dt);
      if(isNaN(d)) return dt;
      const YYYY=d.getFullYear(), MM=('0'+(d.getMonth()+1)).slice(-2), DD=('0'+d.getDate()).slice(-2);
      const HH=('0'+d.getHours()).slice(-2), mm=('0'+d.getMinutes()).slice(-2);
      const week=["日","月","火","水","木","金","土"][d.getDay()];
      return `${YYYY}/${MM}/${DD}(${week}) ${HH}:${mm}`;
    };
    const scheduleHtml=`<div class="text-sm text-gray-600">開始: ${formatDateTime(item.startTime)}　終了: ${formatDateTime(item.endTime)}</div>`;

    // チェックリスト
    const checksContainer=document.createElement("div");
    checksContainer.className="ml-4 mt-2 overflow-hidden transition-all duration-300";
    if(isAllDone && collapseCompleted) checksContainer.style.maxHeight="0px";

    item.checks.forEach((c,idx)=>{
      const sym=c.state===1?"✔":c.state===2?"✖":"";
      const color=c.state===1?"bg-green-500":c.state===2?"bg-red-500":"bg-gray-200";
      const row=document.createElement("div");
      row.className="flex items-center space-x-2 my-1";
      row.innerHTML=`<button onclick="handleCheck(${item.id},${idx})" class="w-8 h-8 rounded-full ${color} text-white text-sm flex-shrink-0">${sym}</button><span class="ml-2">${c.name}</span>${c.date?`<span class="ml-auto text-sm text-gray-500">${c.date}</span>`:""}`;
      checksContainer.appendChild(row);
    });

    const workTypeStr=item.workType?`[${item.workType}]`:"";
    const title=[item.managementNumber,item.propertyName,workTypeStr].filter(Boolean).join(" ");
    const titleDiv=document.createElement("div");
    titleDiv.className="font-bold text-lg cursor-pointer select-none flex justify-between items-center";
    titleDiv.innerHTML=`${title}${isAllDone?" (完了案件)":""}`;
    titleDiv.addEventListener("click",()=>{
      if(isAllDone){
        if(checksContainer.style.maxHeight==="0px") checksContainer.style.maxHeight=checksContainer.scrollHeight+"px";
        else checksContainer.style.maxHeight="0px";
      }
    });

    div.appendChild(titleDiv);
    div.appendChild(scheduleHtml ? (()=>{const d=document.createElement("div"); d.innerHTML=scheduleHtml; return d;})() : null);
    div.appendChild(checksContainer);
    cont.appendChild(div);
  });
  updateProgress();
}

// 完了案件折りたたみ切替
function toggleCompletedAll(){
  collapseCompleted=!collapseCompleted;
  document.getElementById("toggleCompletedBtn").innerText=collapseCompleted?"完了案件を展開":"完了案件を折りたたむ";
  renderChecklist();
}

// 進捗バー
function updateProgress(){
  let total=0, done=0;
  data.forEach(item=>{
    total+=item.checks.length;
    done+=item.checks.filter(c=>c.state===1).length;
  });
  const percent=total===0?0:Math.round(done/total*100);
  document.getElementById("progressContainer").classList.remove("hidden");
  document.getElementById("progressBar").style.width=percent+"%";
  document.getElementById("progressBar").innerText=percent+"%";
  document.getElementById("progressText").innerText=`完了 ${done} / ${total}`;
}

// Excel出力（チェックリスト出力）
function exportExcel(){
  if(data.length===0){ alert("データがありません"); return; }
  const ws_data=[["管理番号","物件名","作業タイプ","予定開始","予定終了"]];
  let checkNames=[];
  data.forEach(item=>{ item.checks.forEach(c=>{ if(!checkNames.includes(c.name)) checkNames.push(c.name); }); });
  checkNames.forEach(name=>{ ws_data[0].push(name+" 状態"); ws_data[0].push(name+" 日時"); });
  data.forEach(item=>{
    const row=[item.managementNumber,item.propertyName,item.workType,item.startTime,item.endTime];
    checkNames.forEach(name=>{
      const c=item.checks.find(x=>x.name===name);
      row.push(c? (c.state===1?"完了":c.state===2?"不要":""):"");
      row.push(c?c.date:"");
    });
    ws_data.push(row);
  });
  const ws=XLSX.utils.aoa_to_sheet(ws_data);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Sheet1");
  const wbout=XLSX.write(wb,{bookType:"xlsx",type:"array"});
  saveAs(new Blob([wbout],{type:"application/octet-stream"}),"checklist.xlsx");
}

// Word出力（貼紙出力）
async function exportWord(){
  if(data.length===0){ alert("Excelデータを先に読み込んでください。"); return; }
  let file=document.getElementById("wordTemplate").files[0];
  let content;
  if(!file){
    try{ const response=await fetch("harigami.docx"); content=await response.arrayBuffer(); } 
    catch(err){ alert("harigami.docx を読み込めませんでした（オフラインの場合はキャッシュが必要です）。"); return; }
  } else { content=await file.arrayBuffer(); }

  const zipOut=new JSZip();
  const dayOfWeek=['日曜日','月曜日','火曜日','水曜日','木曜日','金曜日','土曜日'];
  const h=d=>('0'+d.getHours()).slice(-2);
  const m=d=>('0'+d.getMinutes()).slice(-2);

  for(const item of data){
    const zip=new PizZip(content);
    let doc;
    try{ doc=new window.docxtemplater(zip,{paragraphLoop:true,linebreaks:true}); }
    catch(err){ document.getElementById("message").innerText="テンプレート読み込みエラー: "+err.message; return; }

    const d_start=item.startTime?new Date(item.startTime):null;
    const d_end=item.endTime?new Date(item.endTime):null;
    const date=d_start?`${d_start.getFullYear()}年${d_start.getMonth()+1}月${d_start.getDate()}日（${dayOfWeek[d_start.getDay()]}）`:"";
    const startTime=d_start?h(d_start):"";
    const endTime=d_end?h(d_end):"";

    const dataToRender={'管理番号':item.managementNumber,'物件名':item.propertyName,'日付':date,'予定開始':startTime,'予定終了':endTime};
    doc.setData(dataToRender);

    try{ doc.render(); } 
    catch(err){ document.getElementById("message").innerText=`ドキュメント生成エラー: ${item.propertyName} - ${err.message}`; continue; }

    const out=doc.getZip().generate({type:"blob",mimeType:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"});
    const fname=(item.managementNumber||"") + "_" + (item.propertyName||"") + ".docx";
    zipOut.file(fname,out);
  }

  zipOut.generateAsync({type:"blob"}).then(content=>{ saveAs(content,"word_outputs.zip"); }).catch(err=>{ document.getElementById("message").innerText="ZIPファイル生成エラー: "+err.message; });
}

// PWA対応
if("serviceWorker" in navigator){
  window.addEventListener("load",()=>{
    navigator.serviceWorker.register("service-worker.js").then(reg=>console.log("ServiceWorker registered:",reg),err=>console.error("ServiceWorker registration failed:",err));
  });
}

// 初期化
loadData();
</script>
</body>
</html>