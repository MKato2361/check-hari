<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Excelãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆç®¡ç†ãƒ„ãƒ¼ãƒ«</title>
  <meta name="theme-color" content="#2563eb" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ" />
  <link rel="manifest" href="manifest.json" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* ãƒã‚§ãƒƒã‚¯ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .btn-unchecked {
        @apply bg-gray-200 text-gray-800;
    }
    .btn-checked {
        @apply bg-green-500 text-white;
    }
    .btn-unnecessary {
        @apply bg-red-500 text-white;
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
  <div class="max-w-4xl mx-auto">
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <h1 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
        ğŸ“Š Excelãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆç®¡ç†ãƒ„ãƒ¼ãƒ«
      </h1>
      <div class="border-2 border-dashed border-blue-300 rounded-lg p-6 text-center">
        <input type="file" accept=".xlsx,.xls" id="file-upload" class="hidden" />
        <label for="file-upload" class="cursor-pointer flex flex-col items-center gap-2 text-blue-600 hover:text-blue-800">
          <div class="text-4xl">â¬†ï¸</div>
          <span class="font-semibold text-lg">Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</span>
          <span class="text-sm text-gray-500">(.xlsx, .xlså¯¾å¿œ)</span>
        </label>
        <div id="file-name" class="mt-2 text-sm text-gray-600 hidden"></div>
      </div>
      <div id="loading" class="mt-4 text-center hidden">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
        <p class="mt-2 text-blue-600">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-lg p-6 mb-6 hidden" id="template-section">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">Wordãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ</h2>
      <input type="file" accept=".docx" id="template-upload" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
      <p class="mt-2 text-sm text-gray-500">â€»æœªé¸æŠã®å ´åˆã¯ã€harigami.docxãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚</p>
    </div>

    <div id="progress-section" class="bg-white rounded-lg shadow-lg p-6 mb-6 hidden">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between mb-4">
        <h2 class="text-xl font-semibold text-gray-800">é€²æ—çŠ¶æ³</h2>
        <div class="flex flex-wrap gap-2">
          <button id="export-docx-zip-btn" class="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg">
            ğŸ“„ Wordä¸€æ‹¬å‡ºåŠ›
          </button>
          <button id="export-btn" class="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg">
            â¬‡ï¸ Excelã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
          </button>
        </div>
      </div>
      <div class="mb-4">
        <div class="flex justify-between text-sm text-gray-600 mb-1">
          <span id="progress-text">å®Œäº†: 0 / 0</span>
          <span id="progress-percentage">0%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-3">
          <div id="progress-bar" class="bg-gradient-to-r from-green-500 to-green-600 h-3 rounded-full transition-all duration-300" style="width:0%"></div>
        </div>
      </div>
    </div>

    <div id="add-check-section" class="bg-white rounded-lg shadow-lg p-6 mb-6 hidden">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">ãƒã‚§ãƒƒã‚¯é …ç›®ã‚’è¿½åŠ </h2>
      <div class="flex items-center gap-2">
        <input type="text" id="new-check-name" placeholder="ä¾‹: é›»è©±é€£çµ¡" class="flex-grow rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
        <button id="add-check-btn" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
          è¿½åŠ 
        </button>
      </div>
    </div>

    <div id="checklist-container" class="space-y-4"></div>

    <div id="initial-message" class="bg-white rounded-lg shadow-lg p-12 text-center">
      <p class="text-gray-500 text-lg">Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’é–‹å§‹ã—ã¦ãã ã•ã„</p>
    </div>
  </div>

  <script>
    (function() {
      let data = [];
      let checkNames = [];

      // ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿æ™‚ã«ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
      window.addEventListener('load', () => {
        console.log("ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†");
        if (data.length > 0) {
          renderChecklist();
          updateProgress();
          showSections();
          document.getElementById("initial-message").classList.add("hidden");
        }
      });

      // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®å‡¦ç†
      document.getElementById("file-upload").addEventListener("change", async (event) => {
        console.log("ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ");
        const file = event.target.files[0];
        if (!file) {
          console.log("ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“");
          return;
        }

        console.log("é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:", file.name);
        const loading = document.getElementById("loading");
        const fileName = document.getElementById("file-name");
        const initialMessage = document.getElementById("initial-message");

        loading.classList.remove("hidden");
        fileName.textContent = `é¸æŠä¸­: ${file.name}`;
        fileName.classList.remove("hidden");
        initialMessage.classList.add("hidden");

        try {
          console.log("ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿é–‹å§‹");
          const arrayBuffer = await file.arrayBuffer();
          console.log("ArrayBufferä½œæˆå®Œäº†");
          
          const workbook = XLSX.read(arrayBuffer, { type: "array" });
          console.log("ãƒ¯ãƒ¼ã‚¯ãƒ–ãƒƒã‚¯èª­ã¿è¾¼ã¿å®Œäº†");
          
          const worksheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
          console.log("JSONå¤‰æ›å®Œäº†:", jsonData.length, "è¡Œ");

          const headers = jsonData[0] || [];
          const rows = jsonData.slice(1);
          console.log("ãƒ˜ãƒƒãƒ€ãƒ¼:", headers);

          const findColumn = (keywords) => {
            const index = headers.findIndex((header) =>
              keywords.some((keyword) => header && header.toString().toLowerCase().includes(keyword.toLowerCase()))
            );
            console.log(`ã‚«ãƒ©ãƒ æ¤œç´¢ [${keywords.join(', ')}]:`, index, headers[index]);
            return index;
          };

          const managementNumberCol = findColumn(["ç®¡ç†ç•ªå·","ç•ªå·","id","no"]);
          const propertyNameCol = findColumn(["ç‰©ä»¶å","ç‰©ä»¶","ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£","åç§°"]);
          const workTypeCol = findColumn(["ä½œæ¥­ã‚¿ã‚¤ãƒ—","ä½œæ¥­ç¨®åˆ¥","type","work type"]);
          const startTimeCol = findColumn(["é–‹å§‹","start","äºˆå®šé–‹å§‹","é–‹å§‹æ™‚é–“"]);
          const endTimeCol = findColumn(["çµ‚äº†","end","äºˆå®šçµ‚äº†","çµ‚äº†æ™‚é–“"]);

          const formatDateTime = (v) => {
            if (!v) return "";
            try {
              return XLSX.SSF.format('yyyy/mm/dd hh:mm', v);
            } catch (e) {
              console.log("æ—¥æ™‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚¨ãƒ©ãƒ¼:", e);
              return v.toString();
            }
          };
          
          const formatRawDate = (v) => {
            if (!v) return null;
            try {
              return XLSX.SSF.parse_date_code(v);
            } catch (e) {
              console.log("æ—¥ä»˜ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:", e);
              return null;
            }
          };

          data = rows
            .filter((row) => row.some((c) => c !== undefined && c !== ""))
            .map((row, index) => {
              const item = {
                id: index,
                managementNumber: managementNumberCol >= 0 ? (row[managementNumberCol] || `No.${index + 1}`) : `No.${index + 1}`,
                propertyName: propertyNameCol >= 0 ? (row[propertyNameCol] || "æœªè¨­å®š") : "æœªè¨­å®š",
                workType: workTypeCol >= 0 ? (row[workTypeCol] || "") : "",
                startTime: startTimeCol >= 0 ? formatDateTime(row[startTimeCol]) : "",
                endTime: endTimeCol >= 0 ? formatDateTime(row[endTimeCol]) : "",
                startRaw: startTimeCol >= 0 ? formatRawDate(row[startTimeCol]) : null,
                endRaw: endTimeCol >= 0 ? formatRawDate(row[endTimeCol]) : null,
                checks: checkNames.map(name => ({ name, status: 0, completedAt: null })),
              };
              return item;
            });

          console.log("ãƒ‡ãƒ¼ã‚¿å‡¦ç†å®Œäº†:", data.length, "ã‚¢ã‚¤ãƒ†ãƒ ");
          console.log("ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿:", data[0]);

          renderChecklist();
          updateProgress();
          showSections();
          
          alert(`${data.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
          
        } catch (err) {
          console.error("ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", err);
          alert("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: " + err.message);
        } finally {
          loading.classList.add("hidden");
        }
      });

      // æ‰‹å‹•ã§ãƒã‚§ãƒƒã‚¯é …ç›®åã‚’è¿½åŠ ã™ã‚‹æ©Ÿèƒ½
      document.getElementById("add-check-btn").addEventListener("click", () => {
        const newCheckNameInput = document.getElementById("new-check-name");
        const newCheckName = newCheckNameInput.value.trim();

        if (newCheckName && !checkNames.includes(newCheckName)) {
          checkNames.push(newCheckName);
          data.forEach(item => {
            item.checks.push({
              name: newCheckName,
              status: 0,
              completedAt: null,
            });
          });
          renderChecklist();
          updateProgress();
          
          newCheckNameInput.value = "";
        } else if (checkNames.includes(newCheckName)) {
          alert("ãã®ãƒã‚§ãƒƒã‚¯é …ç›®ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚");
        } else {
          alert("ãƒã‚§ãƒƒã‚¯é …ç›®åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        }
      });
      
      // ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°
      window.handleCheck = function(itemId, checkName) {
        const now = new Date();
        const nowStr = `${now.getFullYear()}/${(now.getMonth() + 1).toString().padStart(2, '0')}/${now.getDate().toString().padStart(2, '0')} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
        
        const item = data.find(i => i.id === itemId);
        if (item) {
          const check = item.checks.find(c => c.name === checkName);
          if (check) {
            check.status = (check.status + 1) % 3;
            check.completedAt = check.status === 1 ? nowStr : null;
            renderChecklist();
            updateProgress();
          }
        }
      };

      // ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹é–¢æ•°
      function renderChecklist() {
        const container = document.getElementById("checklist-container");
        container.innerHTML = "";
        data.forEach((item) => {
          const isCompleted = item.checks.length > 0 && item.checks.every(c => c.status === 1 || c.status === 2);
          const borderColor = isCompleted ? "border-green-500" : "border-blue-500";
          const bgColor = isCompleted ? "bg-green-50" : "bg-white";

          const div = document.createElement("div");
          div.className = `rounded-lg shadow-lg p-4 border-l-4 ${borderColor} ${bgColor}`;

          div.innerHTML = `
            <div class="flex items-start gap-4">
              <div class="flex-grow">
                <span class="font-semibold">${item.managementNumber}</span> ${item.propertyName} ${item.workType ? `(${item.workType})` : ''}
                <div class="mt-2 space-y-2">
                  ${item.startTime ? `<div class="text-sm text-blue-600">é–‹å§‹: ${item.startTime}</div>` : ""}
                  ${item.endTime ? `<div class="text-sm text-red-600">çµ‚äº†: ${item.endTime}</div>` : ""}
                </div>
              </div>
            </div>
            <div class="mt-4 border-t pt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">
              ${item.checks.map(check => {
                  let buttonClass;
                  let buttonText;
                  let ariaLabel;
                  let completedAtHtml = '';
                  if (check.status === 1) {
                      buttonClass = "btn-checked";
                      buttonText = "âœ“";
                      ariaLabel = `${check.name}: å®Œäº†`;
                      completedAtHtml = `<div class="text-xs text-gray-500">${check.completedAt || ''}</div>`;
                  } else if (check.status === 2) {
                      buttonClass = "btn-unnecessary";
                      buttonText = "âœ•";
                      ariaLabel = `${check.name}: ä¸è¦`;
                  } else {
                      buttonClass = "btn-unchecked";
                      buttonText = "â–¡";
                      ariaLabel = `${check.name}: æœªå®Œäº†`;
                  }
                  return `
                      <div class="flex items-center gap-2">
                          <button onclick="handleCheck(${item.id}, '${check.name}')" aria-label="${ariaLabel}" class="w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center text-lg ${buttonClass}">
                              ${buttonText}
                          </button>
                          <div>
                              <div class="text-sm text-gray-700">${check.name}</div>
                              ${completedAtHtml}
                          </div>
                      </div>
                  `;
              }).join('')}
            </div>`;
          container.appendChild(div);
        });
      }

      // é€²æ—ãƒãƒ¼ã¨ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
      function updateProgress() {
        const allChecks = data.flatMap(item => item.checks);
        const completedChecks = allChecks.filter(c => c.status === 1).length;
        const totalChecks = allChecks.length;
        const percent = totalChecks ? Math.round((completedChecks / totalChecks) * 100) : 0;
        document.getElementById("progress-text").textContent = `å®Œäº†: ${completedChecks} / ${totalChecks}`;
        document.getElementById("progress-percentage").textContent = `${percent}%`;
        document.getElementById("progress-bar").style.width = `${percent}%`;
      }

      // Excelã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
      document.getElementById("export-btn").addEventListener("click", () => {
        if (!data.length) {
          alert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
          return;
        }
        
        const exportData = data.map((i) => {
          const row = {
            ç®¡ç†ç•ªå·: i.managementNumber,
            ç‰©ä»¶å: i.propertyName,
            ä½œæ¥­ã‚¿ã‚¤ãƒ—: i.workType,
            äºˆå®šé–‹å§‹æ™‚é–“: i.startTime,
            äºˆå®šçµ‚äº†æ™‚é–“: i.endTime,
          };
          i.checks.forEach(check => {
              let statusText = "æœªå®Œäº†";
              if (check.status === 1) {
                  statusText = "å®Œäº†";
              } else if (check.status === 2) {
                  statusText = "ä¸è¦";
              }
              row[check.name] = statusText;
              row[`${check.name}å®Œäº†æ—¥æ™‚`] = check.completedAt || "";
          });
          return row;
        });

        const ws = XLSX.utils.json_to_sheet(exportData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ");
        XLSX.writeFile(wb, "ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ.xlsx");
      });

      // Wordä¸€æ‹¬å‡ºåŠ›æ©Ÿèƒ½ï¼ˆä¿®æ­£ç‰ˆï¼‰
      document.getElementById("export-docx-zip-btn").addEventListener("click", async () => {
        console.log("Wordä¸€æ‹¬å‡ºåŠ›ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ");
        
        if (!data.length) {
          alert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
          return;
        }

        const templateFile = document.getElementById("template-upload").files[0];
        if (!templateFile) {
          alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚harigami.docxãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚");
          return;
        }

        try {
          // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã¦å‡¦ç†ä¸­ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™
          const btn = document.getElementById("export-docx-zip-btn");
          btn.disabled = true;
          btn.textContent = "ç”Ÿæˆä¸­...";

          console.log("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...");
          const templateContent = await templateFile.arrayBuffer();
          console.log("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†");

          const zip = new JSZip();
          const weekdays = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"];
          
          // ç°¡æ˜“çš„ãªWordæ–‡æ›¸ç”Ÿæˆï¼ˆdocxtemplaterã‚’ä½¿ã‚ãªã„æ–¹æ³•ï¼‰
          for (let i = 0; i < data.length; i++) {
            const item = data[i];
            console.log(`ã‚¢ã‚¤ãƒ†ãƒ  ${i + 1} ã‚’å‡¦ç†ä¸­:`, item);
            
            try {
              // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ã‚³ãƒ”ãƒ¼ã‚’ä½œæˆ
              const itemZip = new JSZip();
              await itemZip.loadAsync(templateContent);
              
              // document.xmlã‚’å–å¾—ã—ã¦ç½®æ›
              const docXml = await itemZip.file("word/document.xml").async("string");
              
              let modifiedXml = docXml;
              
              // æ—¥ä»˜ã®å‡¦ç†
              let dateStr = "";
              let startTime = "";
              let endTime = "";
              let monthForFilename = "";
              
              if (item.startTime) {
                try {
                  const dt = new Date(item.startTime.replace(/(\d{4})\/(\d{1,2})\/(\d{1,2})\s(\d{1,2}):(\d{1,2})/, '$1-$2-$3T$4:$5:00'));
                  if (!isNaN(dt.getTime())) {
                    const month = dt.getMonth() + 1;
                    const day = dt.getDate();
                    const weekday = weekdays[dt.getDay()];
                    dateStr = `${month}æœˆ${day}æ—¥ï¼ˆ${weekday}ï¼‰`;
                    startTime = `${dt.getHours().toString().padStart(2, '0')}:${dt.getMinutes().toString().padStart(2, '0')}`;
                    monthForFilename = `${month}æœˆ`;
                  }
                } catch (e) {
                  console.log("æ—¥ä»˜è§£æã‚¨ãƒ©ãƒ¼:", e);
                }
              }
              
              if (item.endTime) {
                try {
                  const dt = new Date(item.endTime.replace(/(\d{4})\/(\d{1,2})\/(\d{1,2})\s(\d{1,2}):(\d{1,2})/, '$1-$2-$3T$4:$5:00'));
                  if (!isNaN(dt.getTime())) {
                    endTime = `${dt.getHours().toString().padStart(2, '0')}:${dt.getMinutes().toString().padStart(2, '0')}`;
                  }
                } catch (e) {
                  console.log("çµ‚äº†æ™‚é–“è§£æã‚¨ãƒ©ãƒ¼:", e);
                }
              }

              // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¤‰æ•°ã‚’ç½®æ›
              const replacements = {
                '{ç®¡ç†ç•ªå·}': item.managementNumber || '',
                '{ç‰©ä»¶å}': item.propertyName || '',
                '{æ—¥ä»˜}': dateStr,
                '{äºˆå®šé–‹å§‹}': startTime,
                '{äºˆå®šçµ‚äº†}': endTime
              };

              for (const [placeholder, value] of Object.entries(replacements)) {
                const regex = new RegExp(placeholder.replace(/[{}]/g, '\\      // Wordä¸€æ‹¬å‡ºåŠ›æ©Ÿèƒ½ï¼ˆä¿®æ­£ç‰ˆï¼‰
      document.getElementById("export-docx-zip-btn").addEventListener("click", async () => {
        if (!data.length) {
          alert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
          return;
        }

        // å‹•çš„ã«ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
        const loadScript = (src) => {
          return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = src;
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
          });
        };

        try {
          // PizZipã¨DocxtemplaterãŒå­˜åœ¨ã—ãªã„å ´åˆã¯å‹•çš„ã«èª­ã¿è¾¼ã¿
          if (typeof PizZip === 'undefined') {
            await loadScript('https://unpkg.com/pizzip@3.1.4/dist/pizzip.min.js');
          }
          if (typeof Docxtemplater === 'undefined') {
            await loadScript('https://unpkg.com/docxtemplater@3.17.8/build/docxtemplater.min.js');
          }
        } catch (e) {
          alert('ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
          return;
        }

        // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®ç¢ºèªï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦ï¼‰
        const PizZipClass = window.PizZip || PizZip;
        const DocxtemplaterClass = window.Docxtemplater || Docxtemplater;

        if (!PizZipClass || !DocxtemplaterClass) {
          alert("å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚");
          return;
        }
        
        const zip = new JSZip();
        let templateContent;
        const templateFile = document.getElementById("template-upload").files[0];
        
        try {
          if (templateFile) {
            templateContent = await templateFile.arrayBuffer();
          } else {
            alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚harigami.docxãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚");
            return;
          }
        } catch (e) {
          alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
          console.error("Template loading error:", e);
          return;
        }

        const weekdays = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"];
        
        for (const item of data) {
          try {
            // PizZipã¨Docxtemplaterã®åˆæœŸåŒ–
            const zipTemplate = new PizZipClass(templateContent);
            const doc = new DocxtemplaterClass(zipTemplate, {
              paragraphLoop: true,
              linebreaks: true,
            });'), 'g');
                modifiedXml = modifiedXml.replace(regex, value);
              }
              
              // ä¿®æ­£ã—ãŸXMLã‚’ZIPã«æˆ»ã™
              itemZip.file("word/document.xml", modifiedXml);
              
              // ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ
              const docBlob = await itemZip.generateAsync({ type: "blob" });
              
              const safeManagementNumber = (item.managementNumber || "").toString().replace(/[^\w\-_.ã-ã‚“ä¸€-é¾¯]/g, "_");
              const safePropertyName = (item.propertyName || "document").replace(/[^\w\-_.ã-ã‚“ä¸€-é¾¯]/g, "_");
              const filename = `${monthForFilename || ""}${safeManagementNumber}_${safePropertyName}.docx`;
              
              zip.file(filename, docBlob);
              console.log(`ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆå®Œäº†: ${filename}`);
              
            } catch (err) {
              console.error("å€‹åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆã‚¨ãƒ©ãƒ¼:", item.managementNumber, err);
              alert(`ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆã‚¨ãƒ©ãƒ¼ (${item.managementNumber}): ${err.message}`);
            }
          }

          // ZIPãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ
          console.log("ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆä¸­...");
          const zipBlob = await zip.generateAsync({ type: "blob" });
          
          // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          const link = document.createElement('a');
          link.href = URL.createObjectURL(zipBlob);
          link.download = "è²¼ç´™_documents.zip";
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(link.href);
          
          console.log("ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†");
          alert(`${data.length}å€‹ã®Wordãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¾ã—ãŸã€‚`);
          
        } catch (err) {
          console.error("Wordä¸€æ‹¬å‡ºåŠ›ã‚¨ãƒ©ãƒ¼:", err);
          alert("Wordä¸€æ‹¬å‡ºåŠ›ã‚¨ãƒ©ãƒ¼: " + err.message);
        } finally {
          // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
          const btn = document.getElementById("export-docx-zip-btn");
          btn.disabled = false;
          btn.innerHTML = 'ğŸ“„ Wordä¸€æ‹¬å‡ºåŠ›';
        }
      });

      // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
      function showSections() {
        document.getElementById("progress-section").classList.remove("hidden");
        document.getElementById("add-check-section").classList.remove("hidden");
        document.getElementById("template-section").classList.remove("hidden");
      }
    })();
  </script>
</body>
</html>
