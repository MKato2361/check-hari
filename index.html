<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>チェックリスト管理ツール</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pizzip@3.1.5/dist/pizzip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/docxtemplater@3.42.2/build/docxtemplater.js"></script>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#4f46e5">
</head>
<body class="bg-gray-100 p-4">
  <h1 class="text-2xl font-bold mb-4">チェックリスト管理ツール</h1>

  <!-- 操作用UI -->
  <div class="mb-4 space-x-2">
    <input type="file" id="templateUpload" accept=".docx" class="border p-1">
    <button onclick="addRow()" class="bg-blue-500 text-white px-3 py-1 rounded">行追加</button>
    <button onclick="exportExcel()" class="bg-green-500 text-white px-3 py-1 rounded">Excel出力</button>
    <button onclick="exportWord()" class="bg-purple-500 text-white px-3 py-1 rounded">Word出力</button>
  </div>

  <!-- チェックリストテーブル -->
  <div class="overflow-x-auto">
    <table class="min-w-full bg-white" id="checklistTable">
      <thead>
        <tr>
          <th class="border px-2 py-1">管理番号</th>
          <th class="border px-2 py-1">物件名</th>
          <th class="border px-2 py-1">作業タイプ</th>
          <th class="border px-2 py-1">予定開始</th>
          <th class="border px-2 py-1">予定終了</th>
          <th class="border px-2 py-1">チェック項目</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <script>
    let data = [];

    function addRow() {
      const newItem = {
        managementNumber: "M" + (data.length + 1),
        propertyName: "物件" + (data.length + 1),
        workType: "作業" + (data.length + 1),
        startTime: "2025/08/27 10:00",
        endTime: "2025/08/27 12:00",
        checks: [
          { name: "チェック1", state: 0, date: "" },
          { name: "チェック2", state: 0, date: "" }
        ]
      };
      data.push(newItem);
      renderTable();
    }

    function renderTable() {
      const tbody = document.getElementById("tableBody");
      tbody.innerHTML = "";
      data.forEach((item, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="border px-2 py-1">${item.managementNumber}</td>
          <td class="border px-2 py-1">${item.propertyName}</td>
          <td class="border px-2 py-1">${item.workType}</td>
          <td class="border px-2 py-1">${formatDateTime(item.startTime)}</td>
          <td class="border px-2 py-1">${formatDateTime(item.endTime)}</td>
          <td class="border px-2 py-1">${renderChecks(item.checks, idx)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderChecks(checks, rowIdx) {
      return checks.map((c, i) => {
        return `
          <div>
            ${c.name}:
            <select onchange="updateCheck(${rowIdx},${i},this.value)">
              <option value="0" ${c.state===0?"selected":""}></option>
              <option value="1" ${c.state===1?"selected":""}>完了</option>
              <option value="2" ${c.state===2?"selected":""}>不要</option>
            </select>
          </div>
        `;
      }).join("");
    }

    function updateCheck(rowIdx, checkIdx, value) {
      data[rowIdx].checks[checkIdx].state = parseInt(value);
      data[rowIdx].checks[checkIdx].date = value != 0 ? new Date().toLocaleString() : "";
    }

    function formatDateTime(str) {
      if (!str) return "";
      const d = new Date(str);
      if (isNaN(d)) return str;
      const w = ["日","月","火","水","木","金","土"][d.getDay()];
      return `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}(${w}) ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
    }

    // Excel出力
    function exportExcel() {
      if (data.length === 0) {
        alert("データがありません");
        return;
      }

      // ファイル名を先頭データの予定開始年月から決定
      let fileName = "チェックリスト";
      if (data[0].startTime) {
        const d = new Date(data[0].startTime);
        const year = d.getFullYear();
        const month = d.getMonth() + 1;
        fileName = `チェックリスト${year}年${month}月`;
      }

      const ws_data = [["管理番号","物件名","作業タイプ","予定開始","予定終了"]];
      let checkNames = [];
      data.forEach(item => {
        item.checks.forEach(c => {
          if (!checkNames.includes(c.name)) checkNames.push(c.name);
        });
      });
      checkNames.forEach(name => {
        ws_data[0].push(name+" 状態");
        ws_data[0].push(name+" 日時");
      });
      data.forEach(item => {
        const row = [item.managementNumber,item.propertyName,item.workType,item.startTime,item.endTime];
        checkNames.forEach(name => {
          const c=item.checks.find(x=>x.name===name);
          let stateText = "";
          if(c){
            if(c.state===1) stateText="完了";
            else if(c.state===2) stateText="不要";
          }
          row.push(stateText);
          row.push(c?c.date:"");
        });
        ws_data.push(row);
      });
      const ws = XLSX.utils.aoa_to_sheet(ws_data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
      const wbout = XLSX.write(wb,{bookType:"xlsx", type:"array"});
      saveAs(new Blob([wbout],{type:"application/octet-stream"}),`${fileName}.xlsx`);
    }

    // Word出力
    async function exportWord() {
      const templateFile = document.getElementById("templateUpload").files[0];
      let content;
      if(templateFile){
        content = await templateFile.arrayBuffer();
      }else{
        const res = await fetch("harigami.docx");
        content = await res.arrayBuffer();
      }
      const zip = new PizZip(content);
      const doc = new window.docxtemplater(zip, { paragraphLoop: true, linebreaks: true });
      doc.render({ items: data });
      const out = doc.getZip().generate({ type: "blob", mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document" });
      saveAs(out,"checklist.docx");
    }

    // Service Worker 登録
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js')
        .then(reg => console.log('Service Worker登録成功:', reg))
        .catch(err => console.log('Service Worker登録失敗:', err));
    }
  </script>
</body>
</html>
