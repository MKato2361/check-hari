<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Excelãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆç®¡ç†ãƒ„ãƒ¼ãƒ«</title>
  <meta name="theme-color" content="#2563eb" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ" />
  <link rel="manifest" href="manifest.json" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* æœªãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã®ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .btn-unchecked {
        @apply bg-gray-200 text-gray-800;
    }
    /* å®Œäº†çŠ¶æ…‹ã®ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .btn-checked {
        @apply bg-green-500 text-white;
    }
    /* ä¸è¦çŠ¶æ…‹ã®ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .btn-unnecessary {
        @apply bg-red-500 text-white;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pizzip/3.1.6/pizzip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.40.1/docxtemplater.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
  <div class="max-w-4xl mx-auto">
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <h1 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
        ğŸ“Š Excelãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆç®¡ç†ãƒ„ãƒ¼ãƒ«
      </h1>
      <div class="border-2 border-dashed border-blue-300 rounded-lg p-6 text-center">
        <input type="file" accept=".xlsx,.xls" id="file-upload" class="hidden" />
        <label for="file-upload" class="cursor-pointer flex flex-col items-center gap-2 text-blue-600">
          â¬†ï¸
          <span class="font-semibold">Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</span>
          <span class="text-sm text-gray-500">(.xlsx, .xlså¯¾å¿œ)</span>
        </label>
        <div id="file-name" class="mt-2 text-sm text-gray-600 hidden"></div>
      </div>
      <div id="loading" class="mt-4 text-center hidden">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
        <p class="mt-2 text-blue-600">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-lg p-6 mb-6 hidden" id="template-section">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">Wordãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ</h2>
      <input type="file" accept=".docx" id="template-upload" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
      <p class="mt-2 text-sm text-gray-500">â€»æœªé¸æŠã®å ´åˆã¯ã€åŒã˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã® `harigami.docx` ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚</p>
    </div>

    <div id="progress-section" class="bg-white rounded-lg shadow-lg p-6 mb-6 hidden">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between mb-4">
        <h2 class="text-xl font-semibold text-gray-800">é€²æ—çŠ¶æ³</h2>
        <div class="flex flex-wrap gap-2">
          <button id="export-docx-zip-btn" class="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg">
            ğŸ“„ Wordä¸€æ‹¬å‡ºåŠ›
          </button>
          <button id="export-btn" class="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg">
            â¬‡ï¸ Excelã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
          </button>
        </div>
      </div>
      <div class="mb-4">
        <div class="flex justify-between text-sm text-gray-600 mb-1">
          <span id="progress-text">å®Œäº†: 0 / 0</span>
          <span id="progress-percentage">0%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-3">
          <div id="progress-bar" class="bg-gradient-to-r from-green-500 to-green-600 h-3 rounded-full transition-all duration-300" style="width:0%"></div>
        </div>
      </div>
    </div>

    <div id="add-check-section" class="bg-white rounded-lg shadow-lg p-6 mb-6 hidden">
      <h2 class="text-xl font-semibold text-gray-800 mb-4">ãƒã‚§ãƒƒã‚¯é …ç›®ã‚’è¿½åŠ </h2>
      <div class="flex items-center gap-2">
        <input type="text" id="new-check-name" placeholder="ä¾‹: é›»è©±é€£çµ¡" class="flex-grow rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
        <button id="add-check-btn" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
          è¿½åŠ 
        </button>
      </div>
    </div>

    <div id="checklist-container" class="space-y-4"></div>

    <div id="initial-message" class="bg-white rounded-lg shadow-lg p-12 text-center">
      <p class="text-gray-500 text-lg">Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’é–‹å§‹ã—ã¦ãã ã•ã„</p>
    </div>
  </div>

  <script>
    let data = [];
    let checkNames = [];
    const LOCAL_STORAGE_KEY = 'excelChecklistData';
    const CHECK_NAMES_KEY = 'checklistCheckNames';

    // ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿æ™‚ã«ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
    window.addEventListener('load', () => {
        const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
        const savedCheckNames = localStorage.getItem(CHECK_NAMES_KEY);
        if (savedData) {
            try {
                data = JSON.parse(savedData);
                checkNames = savedCheckNames ? JSON.parse(savedCheckNames) : [];
                if (data.length > 0) {
                    renderChecklist();
                    updateProgress();
                    document.getElementById("progress-section").classList.remove("hidden");
                    document.getElementById("add-check-section").classList.remove("hidden");
                    document.getElementById("template-section").classList.remove("hidden");
                    document.getElementById("initial-message").classList.add("hidden");
                }
            } catch (e) {
                console.error("Failed to load data from localStorage", e);
                localStorage.removeItem(LOCAL_STORAGE_KEY);
                localStorage.removeItem(CHECK_NAMES_KEY);
            }
        }
    });

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    document.getElementById("file-upload").addEventListener("change", async (event) => {
      const file = event.target.files[0];
      if (!file) return;

      const loading = document.getElementById("loading");
      const fileName = document.getElementById("file-name");
      const initialMessage = document.getElementById("initial-message");

      loading.classList.remove("hidden");
      fileName.textContent = `é¸æŠä¸­: ${file.name}`;
      fileName.classList.remove("hidden");
      initialMessage.classList.add("hidden");

      try {
        const arrayBuffer = await file.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: "array" });
        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

        const headers = jsonData[0] || [];
        const rows = jsonData.slice(1);

        const findColumn = (keywords) =>
          headers.findIndex((header) =>
            keywords.some((keyword) => header && header.toString().toLowerCase().includes(keyword.toLowerCase()))
          );

        const managementNumberCol = findColumn(["ç®¡ç†ç•ªå·","ç•ªå·","id","no"]);
        const propertyNameCol = findColumn(["ç‰©ä»¶å","ç‰©ä»¶","ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£","åç§°"]);
        const startTimeCol = findColumn(["é–‹å§‹","start","äºˆå®šé–‹å§‹","é–‹å§‹æ™‚é–“"]);
        const endTimeCol = findColumn(["çµ‚äº†","end","äºˆå®šçµ‚äº†","çµ‚äº†æ™‚é–“"]);

        const formatDateTime = (v) => (v ? XLSX.SSF.format('yyyy/mm/dd hh:mm', v) : "");
        const formatRawDate = (v) => v ? XLSX.SSF.parse_date_code(v) : null;

        data = rows
          .filter((row) => row.some((c) => c !== undefined && c !== ""))
          .map((row, index) => ({
            id: index,
            managementNumber: managementNumberCol >= 0 ? row[managementNumberCol] : `No.${index + 1}`,
            propertyName: propertyNameCol >= 0 ? row[propertyNameCol] : "æœªè¨­å®š",
            startTime: startTimeCol >= 0 ? formatDateTime(row[startTimeCol]) : "",
            endTime: endTimeCol >= 0 ? formatDateTime(row[endTimeCol]) : "",
            // rawæ—¥ä»˜ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
            startRaw: startTimeCol >= 0 ? formatRawDate(row[startTimeCol]) : null,
            endRaw: endTimeCol >= 0 ? formatRawDate(row[endTimeCol]) : null,
            checks: [],
          }));
        
        checkNames = [];
        saveToLocalStorage();

        renderChecklist();
        updateProgress();
        document.getElementById("progress-section").classList.remove("hidden");
        document.getElementById("add-check-section").classList.remove("hidden");
        document.getElementById("template-section").classList.remove("hidden");
      } catch (err) {
        alert("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: " + err.message);
      } finally {
        loading.classList.add("hidden");
      }
    });

    // æ‰‹å‹•ã§ãƒã‚§ãƒƒã‚¯é …ç›®åã‚’è¿½åŠ ã™ã‚‹æ©Ÿèƒ½
    document.getElementById("add-check-btn").addEventListener("click", () => {
        const newCheckNameInput = document.getElementById("new-check-name");
        const newCheckName = newCheckNameInput.value.trim();

        if (newCheckName && !checkNames.includes(newCheckName)) {
            checkNames.push(newCheckName);
            data.forEach(item => {
                item.checks.push({
                    name: newCheckName,
                    status: 0,
                    completedAt: null,
                });
            });
            saveToLocalStorage();
            renderChecklist();
            updateProgress();
            
            newCheckNameInput.value = "";
        } else if (checkNames.includes(newCheckName)) {
            alert("ãã®ãƒã‚§ãƒƒã‚¯é …ç›®ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚");
        }
    });
    
    // ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°
    function handleCheck(itemId, checkName) {
      const now = new Date().toLocaleString("ja-JP", { year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit" });
      
      const item = data.find(i => i.id === itemId);
      if (item) {
          const check = item.checks.find(c => c.name === checkName);
          if (check) {
              check.status = (check.status + 1) % 3;
              check.completedAt = check.status === 1 ? now : null;
              saveToLocalStorage();
              renderChecklist();
              updateProgress();
          }
      }
    }

    function renderChecklist() {
      const container = document.getElementById("checklist-container");
      container.innerHTML = "";
      data.forEach((item) => {
        const isCompleted = item.checks.every(c => c.status === 1 || c.status === 2);
        const borderColor = isCompleted ? "border-green-500" : "border-blue-500";
        const bgColor = isCompleted ? "bg-green-50" : "bg-white";

        const div = document.createElement("div");
        div.className = `rounded-lg shadow-lg p-4 border-l-4 ${borderColor} ${bgColor}`;

        div.innerHTML = `
          <div class="flex items-start gap-4">
            <div class="flex-grow">
              <span class="font-semibold">${item.managementNumber}</span> ${item.propertyName}
              <div class="mt-2 space-y-2">
                ${item.startTime ? `<div class="text-sm text-blue-600">é–‹å§‹: ${item.startTime}</div>` : ""}
                ${item.endTime ? `<div class="text-sm text-red-600">çµ‚äº†: ${item.endTime}</div>` : ""}
              </div>
            </div>
          </div>
          <div class="mt-4 border-t pt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">
            ${item.checks.map(check => {
                let buttonClass;
                let buttonText;
                let completedAtHtml = '';
                if (check.status === 1) {
                    buttonClass = "btn-checked";
                    buttonText = "âœ”";
                    completedAtHtml = `<div class="text-xs text-gray-500">${check.completedAt || ''}</div>`;
                } else if (check.status === 2) {
                    buttonClass = "btn-unnecessary";
                    buttonText = "âœ•";
                } else {
                    buttonClass = "btn-unchecked";
                    buttonText = "â–¡";
                }
                return `
                    <div class="flex items-center gap-2">
                        <button onclick="handleCheck(${item.id}, '${check.name}')" class="w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center text-lg ${buttonClass}">
                            ${buttonText}
                        </button>
                        <div>
                            <div class="text-sm text-gray-700">${check.name}</div>
                            ${completedAtHtml}
                        </div>
                    </div>
                `;
            }).join('')}
          </div>`;
        container.appendChild(div);
      });
    }

    function updateProgress() {
      const allChecks = data.flatMap(item => item.checks);
      const completedChecks = allChecks.filter(c => c.status === 1).length;
      const totalChecks = allChecks.length;
      const percent = totalChecks ? Math.round((completedChecks / totalChecks) * 100) : 0;
      document.getElementById("progress-text").textContent = `å®Œäº†: ${completedChecks} / ${totalChecks}`;
      document.getElementById("progress-percentage").textContent = `${percent}%`;
      document.getElementById("progress-bar").style.width = `${percent}%`;
    }

    document.getElementById("export-btn").addEventListener("click", () => {
      if (!data.length) return;
      
      const exportData = data.map((i) => {
        const row = {
          ç®¡ç†ç•ªå·: i.managementNumber,
          ç‰©ä»¶å: i.propertyName,
          äºˆå®šé–‹å§‹æ™‚é–“: i.startTime,
          äºˆå®šçµ‚äº†æ™‚é–“: i.endTime,
        };
        i.checks.forEach(check => {
            let statusText = "æœªå®Œäº†";
            if (check.status === 1) {
                statusText = "å®Œäº†";
            } else if (check.status === 2) {
                statusText = "ä¸è¦";
            }
            row[check.name] = statusText;
            row[`${check.name}å®Œäº†æ—¥æ™‚`] = check.completedAt || "";
        });
        return row;
      });

      const ws = XLSX.utils.json_to_sheet(exportData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ");
      XLSX.writeFile(wb, "ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ.xlsx");
    });
    
    // localStorageã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã™ã‚‹é–¢æ•°
    function saveToLocalStorage() {
        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(data));
        localStorage.setItem(CHECK_NAMES_KEY, JSON.stringify(checkNames));
    }

    // Wordä¸€æ‹¬å‡ºåŠ›æ©Ÿèƒ½
    document.getElementById("export-docx-zip-btn").addEventListener("click", async () => {
        if (!data.length) {
            alert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
            return;
        }
        
        const zip = new JSZip();
        let templateContent;
        const templateFile = document.getElementById("template-upload").files[0];
        
        try {
            if (templateFile) {
                templateContent = await templateFile.arrayBuffer();
            } else {
                templateContent = await fetch("./harigami.docx").then(res => res.arrayBuffer());
            }
        } catch (e) {
            alert("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`harigami.docx`ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            return;
        }

        const weekdays = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"];
        const outputPromises = data.map(async (item) => {
            try {
                const zipTemplate = new PizZip(templateContent);
                const doc = new window.docxtemplater(zipTemplate, {
                    paragraphLoop: true,
                    linebreaks: true,
                });

                let dateStr = "";
                let startTime = "";
                let endTime = "";
                let monthForFilename = "";
                
                if (item.startRaw) {
                    const dt = new Date(item.startRaw);
                    if (!isNaN(dt.getTime())) {
                        const month = dt.getMonth() + 1;
                        const day = dt.getDate();
                        const weekday = weekdays[dt.getDay()];
                        dateStr = `${month}æœˆ${day}æ—¥ï¼ˆ${weekday}ï¼‰`;
                        startTime = dt.toLocaleTimeString("ja-JP", { hour: "2-digit", minute: "2-digit" });
                        monthForFilename = `${month}æœˆ`;
                    }
                }
                if (item.endRaw) {
                    const dt = new Date(item.endRaw);
                    if (!isNaN(dt.getTime())) {
                        endTime = dt.toLocaleTimeString("ja-JP", { hour: "2-digit", minute: "2-digit" });
                    }
                }

                // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’harigamiweb.pyã«åˆã‚ã›ã‚‹
                doc.setData({
                    "æ—¥ä»˜": dateStr,
                    "äºˆå®šé–‹å§‹": startTime,
                    "äºˆå®šçµ‚äº†": endTime,
                    "ç‰©ä»¶å": item.propertyName || ""
                });
                
                doc.render();
                const out = doc.getZip().generate({ type: "blob" });
                const safeManagementNumber = item.managementNumber.toString().replace(/[^a-zA-Z0-9ä¸€-é¾¯ã-ã‚“ã‚¡-ãƒ¶ãƒ¼_\-]/g,"_");
                const safePropertyName = (item.propertyName || "document").replace(/[^a-zA-Z0-9ä¸€-é¾¯ã-ã‚“ã‚¡-ãƒ¶ãƒ¼_\-]/g,"_");
                const filename = `${monthForFilename}_${safeManagementNumber}_${safePropertyName}.docx`;
                zip.file(filename, out);
            } catch (err) {
                console.error("å·®ã—è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", err);
            }
        });

        await Promise.all(outputPromises);
        const zipBlob = await zip.generateAsync({ type: "blob" });
        saveAs(zipBlob, "è²¼ç´™_documents.zip");
    });

    // Service Workerç™»éŒ²
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("sw.js");
      });
    }
  </script>
</body>
</html>
