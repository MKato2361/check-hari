<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>チェックリスト</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100 p-4">
  <h1 class="text-2xl font-bold mb-4">チェックリスト管理</h1>

  <!-- ファイル入力 -->
  <input type="file" id="excelFile" class="mb-4" />

  <!-- 新規チェック項目追加 -->
  <div class="mb-4">
    <input type="text" id="newCheckItem" placeholder="チェック項目を追加" 
      class="border p-2 rounded w-64" />
    <button onclick="addCheckItem()" 
      class="bg-blue-500 text-white px-4 py-2 rounded">追加</button>
  </div>

  <!-- 完了案件の表示/非表示切り替え -->
  <div class="mb-4">
    <button id="toggleDoneBtn" onclick="toggleDoneVisibility()" 
      class="bg-yellow-500 text-white px-4 py-2 rounded">
      完了案件を隠す
    </button>
  </div>

  <!-- 進捗表示 -->
  <div id="progress" class="mb-4 font-bold"></div>

  <!-- チェックリスト本体 -->
  <div id="checklist-container" class="space-y-4"></div>

  <script>
    let data = [];
    let headers = [];
    let hideDone = false;

    document.getElementById("excelFile").addEventListener("change", handleFile, false);

    function handleFile(e){
      const file = e.target.files[0];
      if (!file) return;

      // 確認ダイアログ
      const proceed = confirm("既存のチェック状態は消去されます。読み込んでよろしいですか？");
      if (!proceed) {
        e.target.value = ""; // ファイル選択をリセット
        return;
      }

      // 保存済みチェック状態をリセット
      localStorage.removeItem("checklistData");

      const reader = new FileReader();
      reader.onload = function(evt){
        const wb = XLSX.read(evt.target.result, {type:"binary", cellDates:true, raw:true});
        const ws = wb.Sheets[wb.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(ws, {header:1, defval:""});
        headers = json[0];
        const managementIdx=headers.findIndex(h=>h.includes("管理番号"));
        const propertyIdx=headers.findIndex(h=>h.includes("物件名"));
        const workTypeIdx=headers.findIndex(h=>h.includes("作業タイプ"));
        const startIdx=headers.findIndex(h=>h.includes("予定開始"));
        const endIdx=headers.findIndex(h=>h.includes("予定終了"));
        data=[];
        for(let i=1;i<json.length;i++){
          if(json[i].length===0) continue;
          data.push({
            id:i,
            managementNumber: json[i][managementIdx]||"",
            propertyName: json[i][propertyIdx]||"",
            workType: json[i][workTypeIdx]||"",
            startTime: json[i][startIdx]||"",
            endTime: json[i][endIdx]||"",
            checks:[]
          });
        }
        renderChecklist();
        saveToLocalStorage(); // 新しいデータを保存
      };
      reader.readAsBinaryString(file);
    }

    function renderChecklist(){
      const cont=document.getElementById("checklist-container");
      cont.innerHTML="";

      data.forEach(item=>{
        const isAllDone = item.checks.length > 0 && item.checks.every(c => c.state === 1 || c.state === 2);

        // 完了案件を隠すモードのときは非表示
        if (hideDone && isAllDone) return;

        const div=document.createElement("div");
        div.className=`bg-white p-4 rounded shadow border-2 ${isAllDone ? "border-green-500" : "border-gray-200"}`;

        const formatDateTime = (dt) => {
          if(!dt) return "-";
          const d = new Date(dt);
          if(isNaN(d)) return dt; 
          const YYYY = d.getFullYear();
          const MM = ('0' + (d.getMonth() + 1)).slice(-2);
          const DD = ('0' + d.getDate()).slice(-2);
          const HH = ('0' + d.getHours()).slice(-2);
          const mm = ('0' + d.getMinutes()).slice(-2);
          const week = ["日","月","火","水","木","金","土"][d.getDay()];
          return `${YYYY}/${MM}/${DD}(${week}) ${HH}:${mm}`;
        };

        const scheduleHtml = `
          <div class="text-sm text-gray-600">
            開始: ${formatDateTime(item.startTime)}　
            終了: ${formatDateTime(item.endTime)}
          </div>`;

        let checksHtml="";
        item.checks.forEach((c,idx)=>{
          const sym=c.state===1?"✔":c.state===2?"✖":""; 
          const color=c.state===1?"bg-green-500":c.state===2?"bg-red-500":"bg-gray-200";
          checksHtml+=`
            <div class="flex items-center space-x-2 my-1">
              <button onclick="handleCheck(${item.id},${idx})" 
                class="w-8 h-8 rounded-full ${color} text-white text-sm flex-shrink-0">${sym}</button>
              <span class="ml-2 text-gray-800">${c.name}</span>
              ${c.date?`<span class="ml-auto text-sm text-gray-500">${c.date}</span>`:""}
            </div>`;
        });

        const workTypeStr = item.workType ? `[${item.workType}]` : "";
        const title = [item.managementNumber, item.propertyName, workTypeStr].filter(Boolean).join(" ");

        div.innerHTML=`
          <div class="font-bold text-lg text-gray-900">
            ${title}
          </div>
          ${scheduleHtml}
          <div class="ml-4 mt-2">
            ${checksHtml || "<span class='text-gray-400 text-sm'>チェック項目なし</span>"}
          </div>`;
        cont.appendChild(div);
      });
      updateProgress();
    }

    function addCheckItem(){
      const name=document.getElementById("newCheckItem").value.trim();
      if(!name) return;
      data.forEach(item=>{
        item.checks.push({name, state:0, date:""});
      });
      document.getElementById("newCheckItem").value="";
      renderChecklist();
      saveToLocalStorage();
    }

    function handleCheck(itemId, idx){
      const item=data.find(d=>d.id===itemId);
      const check=item.checks[idx];
      check.state=(check.state+1)%3;
      if(check.state===1){
        const now = new Date();
        const YYYY = now.getFullYear();
        const MM = ('0' + (now.getMonth() + 1)).slice(-2);
        const DD = ('0' + now.getDate()).slice(-2);
        const HH = ('0' + now.getHours()).slice(-2);
        const mm = ('0' + now.getMinutes()).slice(-2);
        const week = ["日","月","火","水","木","金","土"][now.getDay()];
        check.date = `${YYYY}/${MM}/${DD}(${week}) ${HH}:${mm}`;
      } else if(check.state===0){
        check.date="";
      }
      renderChecklist();
      saveToLocalStorage();
    }

    function updateProgress(){
      let total=0, done=0;
      data.forEach(item=>{
        item.checks.forEach(c=>{
          total++;
          if(c.state===1) done++;
        });
      });
      const prog=document.getElementById("progress");
      prog.innerText=`進捗: ${done} / ${total}`;
    }

    function saveToLocalStorage() {
      localStorage.setItem("checklistData", JSON.stringify(data));
    }

    function loadFromLocalStorage() {
      const saved = localStorage.getItem("checklistData");
      if (saved) {
        data = JSON.parse(saved);
        renderChecklist();
      }
    }

    function toggleDoneVisibility() {
      hideDone = !hideDone;
      document.getElementById("toggleDoneBtn").innerText = hideDone ? "完了案件を表示" : "完了案件を隠す";
      renderChecklist();
    }

    window.onload = loadFromLocalStorage;
  </script>
</body>
</html>