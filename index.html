<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Excelãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆç®¡ç†ãƒ„ãƒ¼ãƒ«</title>
  <meta name="theme-color" content="#2563eb" />
  <link rel="manifest" href="manifest.json" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Wordå·®ã—è¾¼ã¿ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pizzip/3.1.6/pizzip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.36.0/docxtemplater.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
  <div class="max-w-4xl mx-auto">
    <!-- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <h1 class="text-2xl font-bold text-gray-800 mb-4">ğŸ“Š Excelãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆç®¡ç†ãƒ„ãƒ¼ãƒ«</h1>
      <div class="border-2 border-dashed border-blue-300 rounded-lg p-6 text-center">
        <input type="file" accept=".xlsx,.xls" id="file-upload" class="hidden" />
        <label for="file-upload" class="cursor-pointer flex flex-col items-center gap-2 text-blue-600">
          â¬†ï¸ <span class="font-semibold">Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</span>
        </label>
        <div id="file-name" class="mt-2 text-sm text-gray-600 hidden"></div>
      </div>
      <div id="loading" class="mt-4 text-center hidden">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
        <p class="mt-2 text-blue-600">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
      </div>
    </div>

    <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé¸æŠ -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6 hidden" id="template-section">
      <h2 class="text-lg font-semibold text-gray-800 mb-2">Wordãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</h2>
      <input type="file" accept=".docx" id="template-upload" class="mb-2" />
      <p class="text-sm text-gray-500">æœªé¸æŠã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® <code>harigami.docx</code> ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚</p>
    </div>

    <!-- ãƒã‚§ãƒƒã‚¯é …ç›®è¿½åŠ  -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6 hidden" id="checkitem-section">
      <h2 class="text-lg font-semibold text-gray-800 mb-2">ãƒã‚§ãƒƒã‚¯é …ç›®</h2>
      <button id="add-check-btn" class="bg-blue-500 text-white px-3 py-1 rounded">
        â• ãƒã‚§ãƒƒã‚¯é …ç›®ã‚’è¿½åŠ 
      </button>
    </div>

    <!-- é€²æ—ï¼†ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ -->
    <div id="progress-section" class="bg-white rounded-lg shadow-lg p-6 mb-6 hidden">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between mb-4">
        <h2 class="text-xl font-semibold text-gray-800">é€²æ—çŠ¶æ³</h2>
        <div class="flex flex-wrap gap-2">
          <button id="export-docx-zip-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg">
            ğŸ“„ Wordä¸€æ‹¬å‡ºåŠ›
          </button>
          <button id="export-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg">
            â¬‡ï¸ Excelã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
          </button>
        </div>
      </div>
      <div class="mb-4">
        <div class="flex justify-between text-sm text-gray-600 mb-1">
          <span id="progress-text">å®Œäº†: 0 / 0</span>
          <span id="progress-percentage">0%</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-3">
          <div id="progress-bar" class="bg-green-500 h-3 rounded-full transition-all duration-300" style="width:0%"></div>
        </div>
      </div>
    </div>

    <!-- ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ -->
    <div id="checklist-container" class="space-y-4"></div>
    <div id="initial-message" class="bg-white rounded-lg shadow-lg p-12 text-center">
      <p class="text-gray-500 text-lg">Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</p>
    </div>
  </div>

  <script>
    let data = [];
    let checkItems = []; // åˆæœŸã¯ç©ºï¼ˆãƒã‚§ãƒƒã‚¯é …ç›®ãªã—ï¼‰

    // Excelèª­è¾¼
    document.getElementById("file-upload").addEventListener("change", async (event) => {
      const file = event.target.files[0];
      if (!file) return;
      document.getElementById("loading").classList.remove("hidden");
      document.getElementById("file-name").textContent = file.name;
      document.getElementById("file-name").classList.remove("hidden");
      document.getElementById("initial-message").classList.add("hidden");
      try {
        const arrayBuffer = await file.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: "array" });
        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        const headers = jsonData[0] || [];
        const rows = jsonData.slice(1);

        const findCol = (keys) => headers.findIndex(h => keys.some(k => h && h.toString().includes(k)));
        const idCol = findCol(["ç®¡ç†ç•ªå·","ç•ªå·","id","no"]);
        const nameCol = findCol(["ç‰©ä»¶å","ç‰©ä»¶","åç§°"]);
        const typeCol = findCol(["ä½œæ¥­ã‚¿ã‚¤ãƒ—","ã‚¿ã‚¤ãƒ—","ç¨®åˆ¥"]); // â† ä½œæ¥­ã‚¿ã‚¤ãƒ—åˆ—
        const startCol = findCol(["é–‹å§‹","äºˆå®šé–‹å§‹"]);
        const endCol = findCol(["çµ‚äº†","äºˆå®šçµ‚äº†"]);

        const fmt = (v) => v ? XLSX.SSF.format('yyyy/mm/dd hh:mm', v) : "";

        data = rows.map((row,i)=>({
          id:i,
          managementNumber:idCol>=0?row[idCol]:`No.${i+1}`,
          propertyName:nameCol>=0?row[nameCol]:"æœªè¨­å®š",
          workType:typeCol>=0?row[typeCol]:"",   // â† ä½œæ¥­ã‚¿ã‚¤ãƒ—
          startTime:startCol>=0?fmt(row[startCol]):"",
          endTime:endCol>=0?fmt(row[endCol]):"",
          startRaw: row[startCol], endRaw: row[endCol],
          checks: [] // åˆæœŸã¯ãƒã‚§ãƒƒã‚¯é …ç›®ãªã—
        }));

        document.getElementById("checkitem-section").classList.remove("hidden");
        document.getElementById("progress-section").classList.remove("hidden");
        document.getElementById("template-section").classList.remove("hidden");
        renderChecklist(); updateProgress();
      } finally {
        document.getElementById("loading").classList.add("hidden");
      }
    });

    // é …ç›®è¿½åŠ 
    document.getElementById("add-check-btn").addEventListener("click",()=>{
      const name = prompt("ãƒã‚§ãƒƒã‚¯é …ç›®åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      if(name){
        checkItems.push(name);
        data.forEach(item=>item.checks.push({name,state:0,date:null}));
        renderChecklist();
      }
    });

    // ãƒã‚§ãƒƒã‚¯æ“ä½œ
    function handleCheck(itemId, idx){
      data=data.map(item=>{
        if(item.id===itemId){
          const c=item.checks[idx];
          c.state=(c.state+1)%3;
          if(c.state===1){
            c.date=new Date().toLocaleString("ja-JP");
          }else{
            c.date=null;
          }
        }
        return item;
      });
      renderChecklist(); updateProgress();
    }

    // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function renderChecklist(){
      const cont=document.getElementById("checklist-container");
      cont.innerHTML="";
      data.forEach(item=>{
        const div=document.createElement("div");
        div.className="bg-white p-4 rounded shadow";

        // äºˆå®šé–‹å§‹ãƒ»çµ‚äº†ã‚’è¡¨ç¤º
        const scheduleHtml = `
          <div class="text-sm text-gray-600">
            é–‹å§‹: ${item.startTime || "-"}ã€€
            çµ‚äº†: ${item.endTime || "-"}
          </div>`;

        let checksHtml="";
        item.checks.forEach((c,idx)=>{
          const sym=c.state===1?"âœ”":c.state===2?"âœ–":"";
          const color=c.state===1?"bg-green-500":c.state===2?"bg-red-500":"bg-gray-200";
          checksHtml+=`
            <button onclick="handleCheck(${item.id},${idx})" 
              class="w-8 h-8 rounded-full ${color} text-white text-sm">${sym}</button>
            <span class="ml-2">${c.name}</span>
            ${c.date?`<span class="ml-2 text-sm text-gray-500">${c.date}</span>`:""}
            <br/>`;
        });

        // ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆç©ºã®å€¤ã¯çœç•¥ã—ã¦ã‚¹ãƒšãƒ¼ã‚¹ã§çµåˆï¼‰
        const title = [item.managementNumber, item.propertyName, item.workType].filter(Boolean).join(" ");

        div.innerHTML=`
          <div class="font-bold text-lg">
            ${title}
          </div>
          ${scheduleHtml}
          <div class="ml-4 mt-2">
            ${checksHtml || "<span class='text-gray-400 text-sm'>ãƒã‚§ãƒƒã‚¯é …ç›®ãªã—</span>"}
          </div>`;
        cont.appendChild(div);
      });
    }

    // é€²æ—
    function updateProgress(){
      const done=data.reduce((s,it)=>s+it.checks.filter(c=>c.state===1).length,0);
      const total=data.reduce((s,it)=>s+it.checks.length,0);
      const pct=total?Math.round(done/total*100):0;
      document.getElementById("progress-text").textContent=`å®Œäº†: ${done} / ${total}`;
      document.getElementById("progress-percentage").textContent=`${pct}%`;
      document.getElementById("progress-bar").style.width=`${pct}%`;
    }

    // Excelã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    document.getElementById("export-btn").addEventListener("click",()=>{
      if(!data.length)return;
      const out=data.map(item=>{
        let row={
          ç®¡ç†ç•ªå·:item.managementNumber,
          ç‰©ä»¶å:item.propertyName,
          ä½œæ¥­ã‚¿ã‚¤ãƒ—:item.workType,
          äºˆå®šé–‹å§‹:item.startTime,
          äºˆå®šçµ‚äº†:item.endTime
        };
        item.checks.forEach(c=>{
          row[`${c.name} çŠ¶æ…‹`]=c.state===1?"å®Œäº†":c.state===2?"ä¸è¦":"æœªå®Œäº†";
          row[`${c.name} æ—¥æ™‚`]=c.state===1?c.date:"";
        });
        return row;
      });
      const ws=XLSX.utils.json_to_sheet(out);
      const wb=XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb,ws,"ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ");
      XLSX.writeFile(wb,"ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ.xlsx");
    });

    // Wordä¸€æ‹¬å‡ºåŠ›
    document.getElementById("export-docx-zip-btn").addEventListener("click", async ()=>{
      if (!data.length) {
        alert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
        return;
      }

      const zip = new JSZip();
      let templateContent;

      const templateFile = document.getElementById("template-upload").files[0];
      if (templateFile) {
        templateContent = await templateFile.arrayBuffer();
      } else {
        templateContent = await fetch("./harigami.docx").then(res => res.arrayBuffer());
      }

      const weekdays = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];

      for (const item of data) {
        try {
          const zipTemplate = new PizZip(templateContent);
          const doc = new window.docxtemplater().loadZip(zipTemplate);

          let dateStr="",startTime="",endTime="",monthForFilename="";
          if(item.startTime){
            const dt=new Date(item.startTime);
            if(!isNaN(dt)){
              const month=dt.getMonth()+1, day=dt.getDate(), weekday=weekdays[dt.getDay()];
              dateStr=`${month}æœˆ${day}æ—¥ï¼ˆ${weekday}ï¼‰`;
              startTime=dt.toLocaleTimeString("ja-JP",{hour:"2-digit",minute:"2-digit"});
              monthForFilename=`${month}æœˆ`;
            }
          }
          if(item.endTime){
            const dt=new Date(item.endTime);
            if(!isNaN(dt)){
              endTime=dt.toLocaleTimeString("ja-JP",{hour:"2-digit",minute:"2-digit"});
            }
          }

          doc.setData({
            "æ—¥ä»˜": dateStr,
            "äºˆå®šé–‹å§‹": startTime,
            "äºˆå®šçµ‚äº†": endTime,
            "ç®¡ç†ç•ªå·": item.managementNumber,
            "ç‰©ä»¶å": item.propertyName || "",
            "ä½œæ¥­ã‚¿ã‚¤ãƒ—": item.workType || ""
          });

          doc.render();

          const out = doc.getZip().generate({ type: "blob" });

          const safeManagementNumber = item.managementNumber.toString().replace(/[^a-zA-Z0-9ä¸€-é¾¯ã-ã‚“ã‚¡-ãƒ¶ãƒ¼_\-]/g,"_");
          const safePropertyName = (item.propertyName||"document").replace(/[^a-zA-Z0-9ä¸€-é¾¯ã-ã‚“ã‚¡-ãƒ¶ãƒ¼_\-]/g,"_");
          const safeWorkType = (item.workType||"").replace(/[^a-zA-Z0-9ä¸€-é¾¯ã-ã‚“ã‚¡-ãƒ¶ãƒ¼_\-]/g,"_");
          const filename = `${monthForFilename}_${safeManagementNumber}_${safePropertyName}_${safeWorkType}.docx`;

          zip.file(filename, out);
        } catch(err){ console.error("å·®ã—è¾¼ã¿ã‚¨ãƒ©ãƒ¼:",err); }
      }

      const zipBlob = await zip.generateAsync({ type:"blob" });
      saveAs(zipBlob,"è²¼ç´™_documents.zip");
    });
  </script>
</body>
</html>
